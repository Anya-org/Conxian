# Contract Guide: `vault.clar`

**Primary Contract:** `contracts/vault.clar`

## 1. Introduction

The `vault.clar` contract is the heart of the Conxian ecosystem. It is a sophisticated smart contract that serves as the primary repository for user-deposited assets. Its main purpose is to manage these assets, apply automated yield-generating strategies, and provide a secure, efficient, and feature-rich experience for users and other protocol contracts.

The vault uses a share-based accounting system, where depositors receive "shares" that represent their proportional ownership of the vault's total assets. As the vault generates yield, the value of each share increases.

## 2. Key Concepts

### Share-Based Accounting

-   **Shares:** When you deposit assets, you receive shares. These shares represent your claim on the vault's assets.
-   **Share Price:** The value of each share is not fixed. It is calculated as `(Total Assets in Vault) / (Total Shares Issued)`. As the vault earns yield and its total assets increase, the value of each share goes up.
-   **Deposits & Withdrawals:** When you deposit, you mint new shares based on the current share price. When you withdraw, you burn your shares to redeem the underlying assets.

### Fees and Reserves

The vault charges fees on various operations to sustain the protocol and reward stakeholders.

-   **Deposit Fee:** A small percentage taken from the deposited amount.
-   **Withdrawal Fee:** A small percentage taken from the withdrawn amount.
-   **Performance Fee:** A percentage of the yield generated by the vault above a certain benchmark.
-   **Flash Loan Fee:** A fee for using the flash loan feature.
-   **Liquidation Fee:** A penalty for liquidating undercollateralized positions.

Fees are split between two reserves:
-   **Treasury Reserve (`treasury-reserve`):** Funds intended for DAO-governed spending, such as development grants, marketing, etc.
-   **Protocol Reserve (`protocol-reserve`):** Funds used to grow the vault's assets, cover operational costs, or act as a safety buffer.

### Autonomous Economics

The vault includes a sophisticated set of "autonomous economics" features designed to automatically adjust its parameters based on market conditions. This reduces the need for constant manual governance intervention.

-   **Utilization-Based Fees:** The withdrawal fee can be automatically adjusted based on the vault's "utilization" (the percentage of the global deposit cap that is filled). If utilization is high, the withdrawal fee may increase to discourage capital flight. If it's low, the fee may decrease to attract liquidity.
-   **Reserve-Based Fees:** The deposit fee can be adjusted based on the size of the protocol reserve relative to the total assets. If the reserve is below its target, the deposit fee may increase to replenish it more quickly.

### Risk Management

The vault has several built-in risk management features:
-   **Global Cap:** A maximum limit on the total assets that can be deposited into the vault.
-   **User Cap:** A maximum limit on the assets a single user can deposit.
-   **Rate Limiting:** A cap on the total deposit volume per block to prevent flash loan attacks or extreme market manipulation.
-   **Paused Mode:** The admin can pause all major functions (deposits, withdrawals) in case of an emergency.

## 3. State Variables

This table describes the key data variables that define the vault's state.

| Variable Name                  | Type          | Description                                                                 |
| ------------------------------ | ------------- | --------------------------------------------------------------------------- |
| `token`                        | `principal`   | The SIP-010 token contract that the vault accepts for deposits.             |
| `admin`                        | `principal`   | The address of the admin contract (typically `.timelock`).                  |
| `paused`                       | `bool`        | If `true`, deposits and withdrawals are disabled.                           |
| `total-balance`                | `uint`        | The total amount of the underlying token held by the vault.                 |
| `total-shares`                 | `uint`        | The total number of shares minted to all users.                             |
| `shares`                       | `map`         | Maps user principals to their share balances.                               |
| `fee-deposit-bps`              | `uint`        | The deposit fee in basis points (1/100th of a percent). Default: `u30` (0.30%). |
| `fee-withdraw-bps`             | `uint`        | The withdrawal fee in basis points. Default: `u10` (0.10%).                 |
| `protocol-reserve`             | `uint`        | The portion of collected fees belonging to the protocol.                    |
| `treasury-reserve`             | `uint`        | The portion of collected fees belonging to the DAO treasury.                |
| `global-cap`                   | `uint`        | The maximum total balance the vault can hold.                               |
| `user-cap`                     | `uint`        | The maximum balance a single user can hold.                                 |
| `auto-economics-enabled`       | `bool`        | Master switch to enable or disable the autonomous economics features.       |

## 4. User Functions

These are the primary functions that end-users will interact with.

### `deposit`

Deposits a specified amount of the vault's token and mints shares for the user.

-   **Parameters:**
    -   `amount uint`: The amount of the token to deposit.
    -   `ft <sip010>`: The trait of the token being deposited. Must match the vault's configured token.
-   **Logic:**
    1.  Checks that the vault is not paused and the amount is valid.
    2.  Verifies the deposit does not exceed the global or user caps.
    3.  Checks against the per-block rate limit if enabled.
    4.  Calculates the deposit fee and the net amount to be credited.
    5.  Calculates the number of shares to mint based on the current total balance and total shares.
    6.  Transfers the `amount` from the user to the vault.
    7.  Updates the user's share balance and the vault's total balances.
    8.  Splits the fee between the protocol and treasury reserves.

### `withdraw`

Burns a specified number of shares to withdraw the corresponding amount of the underlying token.

-   **Parameters:**
    -   `amount uint`: The amount of the underlying token to withdraw.
    -   `ft <sip010>`: The trait of the token being withdrawn.
-   **Logic:**
    1.  Checks that the vault is not paused and the amount is valid.
    2.  Calculates the number of shares required to be burned to receive the `amount`.
    3.  Ensures the user has enough shares.
    4.  Calculates the withdrawal fee.
    5.  Burns the user's shares.
    6.  Transfers the net payout amount (`amount - fee`) to the user.
    7.  Updates the vault's total balances.
    8.  Splits the fee between the protocol and treasury reserves.

### `flash-loan`

Allows a user to take out a flash loan, which must be repaid in the same transaction.

-   **Parameters:**
    -   `amount uint`: The amount of the token to borrow.
    -   `recipient principal`: The address to receive the loan.
-   **Logic:**
    1.  Checks that the vault is not paused and has sufficient liquidity.
    2.  Calculates the flash loan fee.
    3.  Transfers the `amount` to the `recipient`.
    4.  **Requires the recipient to immediately transfer back the `amount` + `fee` within the same transaction.** (This is typically handled via a callback pattern in more advanced implementations).

## 5. Admin Functions

These functions can only be called by the contract's admin (the `.timelock` contract), ensuring changes go through governance.

| Function Name                    | Parameters                               | Description                                                              |
| -------------------------------- | ---------------------------------------- | ------------------------------------------------------------------------ |
| `set-admin`                      | `new principal`                          | Sets a new admin address.                                                |
| `set-fees`                       | `new-deposit-bps uint`, `new-withdraw-bps uint` | Sets the deposit and withdrawal fees.                                    |
| `set-paused`                     | `p bool`                                 | Pauses or unpauses the vault's core functions.                           |
| `set-global-cap`                 | `cap uint`                               | Sets the maximum total balance for the vault.                            |
| `set-user-cap`                   | `cap uint`                               | Sets the maximum balance for a single user.                              |
| `set-token`                      | `c principal`                            | Changes the underlying SIP-010 token (requires vault to be paused and empty). |
| `set-treasury`                   | `p principal`                            | Sets the address of the treasury.                                        |
| `set-fee-split-bps`              | `bps uint`                               | Sets the split of fees between the protocol and treasury reserves.       |
| `set-rate-limit`                 | `enabled bool`, `cap-per-block uint`     | Configures the per-block deposit rate limit.                             |
| `set-auto-economics-enabled`     | `enabled bool`                           | Enables or disables the autonomous economics engine.                     |
| `set-util-thresholds`            | `high uint`, `low uint`                  | Sets the high/low utilization thresholds for automatic fee adjustments.  |
| `set-fee-bounds`                 | `min uint`, `max uint`                   | Sets the minimum/maximum bounds for the automatically adjusted withdrawal fee. |
| `set-performance-benchmark`      | `apy-bps uint`                           | Sets the APY benchmark for calculating performance fees.                 |

## 6. Keeper Functions

This function is designed to be called periodically by anyone (e.g., an automated "keeper" bot) to keep the protocol's parameters up-to-date.

### `update-autonomics`

Triggers the autonomous economics engine to adjust fees based on the current state of the vault.

-   **Parameters:** None.
-   **Logic:**
    1.  Checks if autonomous economics are enabled.
    2.  Calls `update-fees-based-on-utilization` to adjust the withdrawal fee.
    3.  Adjusts the deposit fee based on the protocol reserve's ratio compared to its target band.

## 7. Read-Only Functions

These functions can be called by anyone to query the state of the vault without creating a transaction.

| Function Name         | Parameters        | Returns                                           | Description                                                     |
| --------------------- | ----------------- | ------------------------------------------------- | --------------------------------------------------------------- |
| `get-balance`         | `who principal`   | `uint`                                            | The underlying token balance for a given user.                  |
| `get-shares`          | `who principal`   | `uint`                                            | The share balance for a given user.                             |
| `get-total-balance`   | -                 | `uint`                                            | The total balance of the underlying token in the vault.         |
| `get-total-shares`    | -                 | `uint`                                            | The total shares minted by the vault.                           |
| `get-fees`            | -                 | `tuple`                                           | A tuple containing all current fee rates.                       |
| `get-paused`          | -                 | `bool`                                            | The current paused state of the vault.                          |
| `get-global-cap`      | -                 | `uint`                                            | The global deposit cap.                                         |
| `get-utilization`     | -                 | `uint`                                            | The current vault utilization as a percentage.                  |
| `get-revenue-stats`   | -                 | `tuple`                                           | A tuple with detailed statistics on collected fees and reserves. |

## 8. Error Codes

| Code   | Description          |
| ------ | -------------------- |
| `u1`   | Invalid amount (e.g., zero). |
| `u2`   | Insufficient balance or shares. |
| `u100` | Unauthorized (caller is not the admin). |
| `u101` | Invalid fee value (e.g., > 100%). |
| `u102` | Global cap exceeded. |
| `u103` | Action not allowed while vault is paused/unpaused. |
| `u104` | User cap exceeded. |
| `u105` | Rate limit for the block exceeded. |
| `u200` | Token transfer failed. |
| `u201` | Invalid token provided. |
